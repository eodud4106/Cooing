<!DOCTYPE html>
<head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://code.jquery.com/ui/jquery-ui-git.css" rel="stylesheet"/>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>

        // [start] 맵을 쓰기 위한 코드
        Map = function(){
            this.map = new Object();
        };   
        Map.prototype = {   
            put : function(key, value){   
                this.map[key] = value;
            },   
            get : function(key){   
                return this.map[key];
            },
            containsKey : function(key){    
                return key in this.map;
            },
            containsValue : function(value){    
                for(var prop in this.map){
                    if(this.map[prop] == value) return true;
                }
                return false;
            },
            isEmpty : function(key){    
                return (this.size() == 0);
            },
            clear : function(){   
                for(var prop in this.map){
                    delete this.map[prop];
                }
            },
            remove : function(key){    
                delete this.map[key];
            },
            keys : function(){   
                var keys = new Array();   
                for(var prop in this.map){   
                    keys.push(prop);
                }   
                return keys;
            },
            values : function(){   
                var values = new Array();   
                for(var prop in this.map){   
                    values.push(this.map[prop]);
                }   
                return values;
            },
            size : function(){
                var count = 0;
                for (var prop in this.map) {
                    count++;
                }
                return count;
            }
        };
        // [end] 맵을 쓰기 위한 코드

        // 전역 변수 선언
        var map_textbox = new Map();    //textbox를 담을 map
        var count = 0;                  //각 텍스트박스에 id를 주기 위해 증가시킬 변수

        // [start] 페이지 로딩 후 처리
        $(document).ready(function(){

            //캔버스 변수 선언, 엘리멘트 연결
            var canvas = $("#canvas");

            // .tool을 드래그할 경우 드래그한 element를 복제한 helper 생성
            // (캔버스 위에 생성되는 textbox는 helper 속성을 물려받는다.)
            $(".tool").draggable({
                helper: "clone"
            });

            // 캔버스에 아이템 드랍 시 이벤트 처리
            canvas.droppable({
                drop: function(event, ui) {

                    // node는 각 텍스트 상자, node를 상기 기본값으로 초기화한다.
                    var id = 'textbox_' + count;

                    // node 객체 생성
                    var node = {
                        id: id,
                        position: ui.helper.position(),
                        width: ui.helper.width,
                        height: ui.helper.height
                    };

                    // node의 최초 위치 조정..?
                    node.position.left -= canvas.position().left;

                    // 드랍한 아이템이 3가지 텍스트 메뉴 중 어느 것인지 판별해서 type에 저장
                    if(ui.helper.hasClass("tool-1")){
                        node.type = "TOOL-1";
                    } else if(ui.helper.hasClass("tool-2")){
                        node.type = "TOOL-2";
                    } else if(ui.helper.hasClass("tool-3")){
                        node.type = "TOOL-3";
                    } else {
                        return;
                    }

                    // node를 map에 저장
                    map_textbox.put(id, node);

                    // 드랍으로 만든 node를 canvas 위에 그림
                    renderTextbox(node);

                    // node의 아이디를 구별하기 위해 1 증가
                    count++;
                }
            });

        });
        // [end] 페이지 로딩 후 처리

        //TODO canvas 초기화
        function init_canvas(diagram) {
            canvas.empty();
        }

        // [start] 텍스트 박스를 캔버스에 추가
        function renderTextbox(node) {

            // 위치, 크기 조절 이벤트 적용할 textbox
            var div_textbox = document.createElement('div');

            // textfield에 기본 텍스트 삽입, 기본 스타일 적용
            $(div_textbox).html(node.type).addClass('div_textbox');

            // node의 타입별 textfield 기본 폰트 크기 지정
            switch(node.type) {
                case "TOOL-1": $(div_textbox).css("font-size", "20pt"); break;
                case "TOOL-2": $(div_textbox).css("font-size", "15pt"); break;
                case "TOOL-3": $(div_textbox).css("font-size", "10pt"); break;
            }

            // 변수명 그대로 textbox 클래스 부여, id는 파라미터 node의 id 적용
            $(div_textbox).addClass('textbox').attr('id', node.id);
            
            // textbox 이동, 크기 조절 ON
            $(div_textbox).css({
                "position": "absolute",
                "top": node.position.top,
                "left": node.position.left,
                "width": node.width,
                "height": node.height
            }).draggable({
                // textbox 드래그 시 위치 이동 처리 (ui.helper는 이벤트의 대상)
                stop: function(event, ui) {
                    var id = ui.helper.attr("id");
                    var textbox = map_textbox.get(id);
                    textbox.position.top = ui.position.top;
                    textbox.position.left = ui.position.left;
                },
                containment: '#canvas'  // 캔버스 영역 밖으로 나가지 못하게 제한
            }).resizable({
                // textbox 크기 조절 처리
                stop: function(event, ui) {
                    var id = ui.helper.attr("id");
                    var textbox = map_textbox.get(id);
                    textbox.width = $(this).width();
                    textbox.height = $(this).height();
                },
                containment: "#canvas", // 캔버스 영역을 넘지 못하도록 제한
                disabled: true
            });

            // canvas에 textbox 출력
            $(div_textbox).find(".ui-resizable-handle").hide();
            canvas.append(div_textbox);

            // textbox 더블클릭 시 텍스트 편집 모드로 전환
            $(div_textbox).dblclick(function(){

                removeTextEdit();

                // textfiled를 수정 가능하게 변경
                $(div_textbox).prop("contenteditable", true);

                // textbox 드래그 끔, 리사이즈 켬, 수정 중 css 적용
                $(div_textbox).draggable('disable').resizable('enable')
                    .addClass('onEditing').find(".ui-resizable-handle").show();

                // [start] 텍스트 편집 옵션창 생성

                               // 텍스트 편집 옵션 리스트를 담을 ul 태그
                var ul_textOption = document.createElement('ul');

                // 왼쪽 정렬
                var li_align_left = document.createElement('li');
                $(li_align_left).text('왼쪽 정렬');
                $(li_align_left).click(function() {
                    $(div_textbox).css("text-align", "left");
                });

                // 가운데 정렬
                var li_align_center = document.createElement('li');
                $(li_align_center).text('가운데 정렬');
                $(li_align_center).click(function() {
                    $(div_textbox).css("text-align", "center");
                });

                // 오른쪽 정렬
                var li_align_right = document.createElement('li');
                $(li_align_right).text('오른쪽 정렬');
                $(li_align_right).click(function() {
                    $(div_textbox).css("text-align", "right");
                });

                // 볼드 TODO -> 드래그한 글자의 위치를 불러와서... 글자의 앞, 뒤에 태그 삽입, 드래그한 글자 내부에 이미 태그가 들어가 있을 경우
                // 태그가 끝나는 </> 의 앞에 닫는 태그 추가하고 그 뒤에 다시 태그 삽입해서 처리...
                var li_bold = document.createElement('li');
                $(li_bold).text('볼드');
                $(li_bold).click(function(e) {
                    surroundSelection();
                });

                $(ul_textOption).append(li_align_left);
                $(ul_textOption).append(li_align_center);
                $(ul_textOption).append(li_align_right);
                $(ul_textOption).append(li_bold);

                // 텍스트 편집 옵션창
                var div_textOption = document.createElement('div');
                $(div_textOption).addClass('textOption').css({
                    "position": "absolute",
                    "top": $(this).position().top-$("#canvas").position().top-50,
                    "left": $(this).position().left+$("#canvas").position().left,
                    "width": "300px",
                    "height": "100px",
                    "z-index": "1000",
                    "-webkit-user-select": "none",
                    "user-select": "none"
                }).prop("contenteditable", false).addClass('div_textOption');

                $(div_textOption).append(ul_textOption);
                $('body').append(div_textOption);

 
                // [end] 텍스트 편집 옵션창 생성

                $(div_textbox).mousedown(function(e) {
                    e.stopPropagation();
                });
                
                // textfiled가 아닌 다른 곳 클릭 시 텍스트 편집 모드 종료
                $('#canvas').mousedown(function(e) {
                    
                    // 편집 옵션 창 제거
                    $(div_textOption).remove();

                    // 수정 불가능하게 변경
                    $(div_textbox).prop("contenteditable", false);

                    // 드래그 켬, 리사이즈 끔, 수정 중 css 제거
                    $(div_textbox).draggable('enable').resizable('disable')
                        .removeClass('onEditing').find(".ui-resizable-handle").hide();
                    
                });

            });

        }
        // [end] 텍스트 박스를 캔버스에 추가

        // 선택한 문자열에 스타일 태그 적용
        function surroundSelection() {
            var span = document.createElement("span");
            span.style.fontWeight = "bold";
            
            if (window.getSelection) {
                var sel = window.getSelection();
                if (sel.rangeCount) {
                    var range = sel.getRangeAt(0).cloneRange();
                    range.surroundContents(span);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
        }

        function removeTextEdit() {
            // 편집 옵션 창 제거
            $('.textOption').remove();

            // 수정 불가능하게 변경
            $('.div_textbox').prop("contenteditable", false);

            // 드래그 켬, 리사이즈 끔, 수정 중 css 제거
            $('.div_textbox').draggable('enable').resizable('disable')
                .removeClass('onEditing').find(".ui-resizable-handle").hide();
        }

    </script>
    <style>
        .textbox {
            padding: 5px;
            z-index: 2;
        }
        .onEditing {
            border: 2px solid gray;
            border-radius: 5px;
            z-index: 10;
        }
        .div_textbox {
            white-space: pre-wrap;
            word-break: break-all;
            font-family: 
        }
        .ui-resizable-helper {
            border: 2px dotted #00F;
        }
        .tool-1 {
            font-size: 20pt;
        }
        .tool-2 {
            font-size: 15pt;
        }
        .tool-3 {
            font-size: 10pt;
        }
        .div_textbox:focus {
            outline: none;
        }
        .div_textOption {
            border: 2px solid gray;
            border-radius: 5px;
            text-align: left;
            font-size: 10pt;
            background-color: rgba(20, 20, 20, .7); 
            padding: 5px;
        }
        .div_textOption ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .div_textOption ul li {
            float: left;
            margin: 5px;
            padding: 0 0 0 0;
            border: 2px solid rgba(170, 170, 170, .7);
            background-color: rgba(170, 170, 170, .7); 
            border-radius: 5px;
            color: white;
        }
        .div_textOption ul li:hover {
            cursor: pointer;
        }
        #div_list_tools div {
            border: 2px solid gray;
            border-radius: 5px;
        }
    </style>

</head>
<body>
    <div class="container-fluid" style="position: absolute;bottom: 0px;top: 0px;left: 0px;right: 0px;">
        <h1 id="test">Drag and Drop Tools Onto Canvas 흰둥</h1>
        <div class="row" style="height: 100%;position: relative;">
            <div class="col-xs-3 tools" id="div_list_tools" style="background-color: #9acfea; position: absolute;top: 0px;bottom: 0px;left: 0px;">
                <h2>Tools</h2>
                <div class="tool tool-1 textbox" id="outputCompany"><span>Tool 1</span></div>
                <div class="tool tool-2 textbox" id="outputMessage"><span>Tool 2</span></div>
                <div class="tool tool-3 textbox" id="outputName"><spam>Tool 3</spam></div>
            </div>
            <div class="col-xs-9 canvas" id="canvas"
                style="background-color: beige;position: absolute;right: 0px;bottom: 0px;top: 0px;">
            </div>
        </div>
        <div class="box">       
            <div class="d1" id = "con_father">
                <h2 id = "con">제작자 흰둥이</h2>
            </div>      
        </div>
    </div>
</body>
</html>
